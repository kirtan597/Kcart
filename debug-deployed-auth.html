<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Deployed Authentication</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .log { background: #f8f9fa; padding: 5px; margin: 2px 0; border-left: 3px solid #007bff; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Debug Deployed Authentication</h1>
    <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
    <p><strong>Environment:</strong> <span id="environment"></span></p>
    
    <div class="test-section">
        <h2>1. Test Netlify Function Directly</h2>
        <button onclick="testNetlifyFunction()">Test /.netlify/functions/user</button>
        <div id="netlifyResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Test All Endpoints with Detailed Logging</h2>
        <button onclick="testAllEndpointsDetailed()">Test All Endpoints</button>
        <div id="detailedResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Simulate Exact Login Flow</h2>
        <div>
            <input type="email" id="testEmail" placeholder="Email" value="user@gmail.com">
            <input type="password" id="testPassword" placeholder="Password" value="12345678">
            <button onclick="simulateExactLogin()">Simulate Login</button>
        </div>
        <div id="simulateResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Test Fallback Authentication Only</h2>
        <button onclick="testFallbackOnly()">Test Fallback Only</button>
        <div id="fallbackResult"></div>
    </div>

    <div class="test-section">
        <h2>5. Console Logs</h2>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="consoleLogs"></div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            updateConsole();
            console.log(logEntry);
        }
        
        function updateConsole() {
            const consoleDiv = document.getElementById('consoleLogs');
            consoleDiv.innerHTML = logs.map(log => 
                `<div class="log" style="border-left-color: ${log.type === 'error' ? 'red' : log.type === 'success' ? 'green' : '#007bff'}">${log.message}</div>`
            ).join('');
        }
        
        function clearLogs() {
            logs = [];
            updateConsole();
        }
        
        document.getElementById('currentUrl').textContent = window.location.origin;
        document.getElementById('environment').textContent = window.location.hostname.includes('localhost') ? 'Local' : 'Deployed';
        
        async function testNetlifyFunction() {
            const resultDiv = document.getElementById('netlifyResult');
            resultDiv.innerHTML = '<div class="warning">Testing Netlify function...</div>';
            log('Testing Netlify function directly');
            
            const endpoint = '/.netlify/functions/user';
            
            try {
                // Test GET first (health check)
                log(`Testing GET ${endpoint}`);
                const getResponse = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                log(`GET response status: ${getResponse.status}`);
                const getResult = await getResponse.text();
                log(`GET response body: ${getResult.substring(0, 200)}`);
                
                // Test POST (login)
                log(`Testing POST ${endpoint}`);
                const postResponse = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'user@gmail.com',
                        password: '12345678'
                    })
                });
                
                log(`POST response status: ${postResponse.status}`);
                const postResult = await postResponse.text();
                log(`POST response body: ${postResult.substring(0, 200)}`);
                
                let postData;
                try {
                    postData = JSON.parse(postResult);
                } catch (e) {
                    postData = { raw: postResult };
                }
                
                if (getResponse.ok && postResponse.ok && postData.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ Netlify function is working!<br>
                            <strong>GET Status:</strong> ${getResponse.status}<br>
                            <strong>POST Status:</strong> ${postResponse.status}<br>
                            <strong>Login Success:</strong> ${postData.success}<br>
                            <pre>${JSON.stringify(postData, null, 2)}</pre>
                        </div>
                    `;
                    log('Netlify function test: SUCCESS', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ❌ Netlify function issues detected<br>
                            <strong>GET Status:</strong> ${getResponse.status}<br>
                            <strong>POST Status:</strong> ${postResponse.status}<br>
                            <strong>GET Body:</strong> <pre>${getResult}</pre>
                            <strong>POST Body:</strong> <pre>${postResult}</pre>
                        </div>
                    `;
                    log('Netlify function test: FAILED', 'error');
                }
                
            } catch (error) {
                log(`Netlify function error: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <div class="error">
                        ❌ Netlify function error: ${error.message}
                    </div>
                `;
            }
        }
        
        async function testAllEndpointsDetailed() {
            const resultDiv = document.getElementById('detailedResult');
            resultDiv.innerHTML = '<div class="warning">Testing all endpoints with detailed logging...</div>';
            log('Starting detailed endpoint testing');
            
            const endpoints = [
                window.location.origin + '/.netlify/functions/user',
                '/.netlify/functions/user',
                '/user',
                '/api/user/auth'
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                log(`Testing endpoint: ${endpoint}`);
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'user@gmail.com',
                            password: '12345678'
                        })
                    });
                    
                    log(`${endpoint} - Status: ${response.status}`);
                    const responseText = await response.text();
                    log(`${endpoint} - Response: ${responseText.substring(0, 100)}`);
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        data = { raw: responseText };
                    }
                    
                    results.push({
                        endpoint,
                        status: response.status,
                        ok: response.ok,
                        data,
                        success: response.ok && data.success
                    });
                    
                } catch (error) {
                    log(`${endpoint} - Error: ${error.message}`, 'error');
                    results.push({
                        endpoint,
                        error: error.message,
                        success: false
                    });
                }
            }
            
            let html = '<h3>Detailed Endpoint Results:</h3>';
            results.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                html += `
                    <div class="${statusClass}" style="margin: 10px 0; padding: 10px;">
                        <strong>${result.endpoint}</strong><br>
                        ${result.success ? 
                            `✅ SUCCESS - Status: ${result.status}<br><pre>${JSON.stringify(result.data, null, 2)}</pre>` :
                            `❌ FAILED - ${result.error || `Status: ${result.status}, Data: ${JSON.stringify(result.data, null, 2)}`}`
                        }
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
            log('Detailed endpoint testing completed');
        }
        
        async function simulateExactLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const resultDiv = document.getElementById('simulateResult');
            
            resultDiv.innerHTML = '<div class="warning">Simulating exact login flow...</div>';
            log(`Simulating login for: ${email}`);
            
            // Simulate the exact same logic as the React app
            const backendUrl = window.location.origin + '/.netlify/functions';
            const endpoints = [
                backendUrl + "/user",
                "/.netlify/functions/user", 
                "/api/user/auth"
            ];
            
            let response;
            let apiWorked = false;
            let attemptResults = [];
            
            // Try each endpoint
            for (const endpoint of endpoints) {
                try {
                    log(`Trying endpoint: ${endpoint}`);
                    
                    const fetchResponse = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password }),
                        timeout: 5000
                    });
                    
                    const data = await fetchResponse.json();
                    log(`${endpoint} - Status: ${fetchResponse.status}, Success: ${data.success}`);
                    
                    attemptResults.push({
                        endpoint,
                        status: fetchResponse.status,
                        data,
                        success: data.success
                    });
                    
                    if (data.success) {
                        apiWorked = true;
                        response = { data };
                        log(`Success with endpoint: ${endpoint}`, 'success');
                        break;
                    }
                } catch (endpointError) {
                    log(`${endpoint} failed: ${endpointError.message}`, 'error');
                    attemptResults.push({
                        endpoint,
                        error: endpointError.message,
                        success: false
                    });
                }
            }
            
            // If no API endpoint worked, use fallback
            if (!apiWorked) {
                log('All API endpoints failed, using fallback authentication');
                
                const demoUsers = [
                    { email: 'user@gmail.com', password: '12345678', name: 'Demo User' },
                    { email: 'admin@kcart.com', password: 'admin123', name: 'Admin User', isAdmin: true }
                ];
                
                const user = demoUsers.find(u => u.email === email && u.password === password);
                if (user) {
                    const token = user.isAdmin ? `admin_token_${Date.now()}` : `demo_token_${Date.now()}`;
                    response = {
                        data: {
                            success: true,
                            token,
                            user: { name: user.name, email: user.email, isAdmin: user.isAdmin || false },
                            message: 'Login successful'
                        }
                    };
                    apiWorked = true;
                    log('Fallback authentication successful', 'success');
                } else {
                    log('Fallback authentication failed - invalid credentials', 'error');
                }
            }
            
            // Display results
            let html = '<h3>Login Simulation Results:</h3>';
            
            // Show API attempts
            html += '<h4>API Endpoint Attempts:</h4>';
            attemptResults.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                html += `
                    <div class="${statusClass}" style="margin: 5px 0; padding: 8px;">
                        <strong>${result.endpoint}</strong><br>
                        ${result.success ? 
                            `✅ Success - ${JSON.stringify(result.data)}` :
                            `❌ Failed - ${result.error || JSON.stringify(result.data)}`
                        }
                    </div>
                `;
            });
            
            // Show final result
            if (apiWorked && response?.data?.success) {
                html += `
                    <div class="success">
                        <h4>✅ Final Result: LOGIN SUCCESSFUL</h4>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>
                    </div>
                `;
            } else {
                html += `
                    <div class="error">
                        <h4>❌ Final Result: LOGIN FAILED</h4>
                        <p>All endpoints failed and fallback authentication did not work.</p>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        async function testFallbackOnly() {
            const resultDiv = document.getElementById('fallbackResult');
            resultDiv.innerHTML = '<div class="warning">Testing fallback authentication only...</div>';
            log('Testing fallback authentication only');
            
            const demoUsers = [
                { email: 'user@gmail.com', password: '12345678', name: 'Demo User' },
                { email: 'admin@kcart.com', password: 'admin123', name: 'Admin User', isAdmin: true }
            ];
            
            const testCases = [
                { email: 'user@gmail.com', password: '12345678', shouldWork: true },
                { email: 'admin@kcart.com', password: 'admin123', shouldWork: true },
                { email: 'invalid@email.com', password: 'wrongpass', shouldWork: false }
            ];
            
            let html = '<h3>Fallback Authentication Tests:</h3>';
            
            testCases.forEach(testCase => {
                const user = demoUsers.find(u => u.email === testCase.email && u.password === testCase.password);
                const worked = !!user;
                const statusClass = worked === testCase.shouldWork ? 'success' : 'error';
                
                html += `
                    <div class="${statusClass}" style="margin: 5px 0; padding: 8px;">
                        <strong>${testCase.email}</strong><br>
                        Expected: ${testCase.shouldWork ? 'Success' : 'Failure'}, 
                        Got: ${worked ? 'Success' : 'Failure'}
                        ${worked ? `<br>User: ${user.name}, Admin: ${user.isAdmin || false}` : ''}
                    </div>
                `;
                
                log(`Fallback test - ${testCase.email}: ${worked ? 'SUCCESS' : 'FAILED'}`, worked ? 'success' : 'error');
            });
            
            resultDiv.innerHTML = html;
        }
        
        // Auto-run tests on page load
        window.onload = function() {
            setTimeout(() => {
                testNetlifyFunction();
            }, 1000);
        };
    </script>
</body>
</html>